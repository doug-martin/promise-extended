/*! promise-extended - v0.0.1 - 2013-01-16
* Copyright (c) 2013 Doug Martin; Licensed MIT */
(function(){"use strict";function t(t,n){return n=n||0,e.call(t,n)}function n(e,n,r,i,s){function p(e,t){return function(){try{x(e.apply(null,arguments)).addCallback(t).addErrback(t)}catch(r){t.errback(r)}}}function w(e,t,n){var r=(new y).callback();return o(e,function(e){r=r.then(n?e:h(null,e)),n||(r=r.then(function(e){return t.push(e),t}))}),r}function E(e){return!u(e)&&f(e.then)}function S(e){var t=new y;return e.then(c(t,"callback"),c(t,"errback")),t.promise()}function x(e){var n;return e=t(arguments),e.length?e.length==1?(e=e.pop(),E(e)?e.addCallback&&e.addErrback?n=e:(console.log(e),n=S(e)):a(e)&&r.every(e,E)?n=(new b(e,!0)).promise():n=(new y).callback(e)):n=(new b(r.map(e,function(e){return x(e)}),!0)).promise():n=(new y).callback(e).promise(),n}function T(e,n){return function(){var i=new y,s=t(arguments);return s.push(i.resolve.bind(i)),e.apply(n||this,s),i.promise()}}function N(e){if(a(e))return w(e,[],!1);throw new Error("When calling promise.serial the first argument must be an array")}function C(e){if(a(e))return w(e,[],!0);throw new Error("When calling promise.serial the first argument must be an array")}function k(e,n){e=t(arguments);var r=!1;n=e.pop();var i=x(e);return function(){return r?x(n.apply(this,arguments)):(e=arguments,i.then(function(){return r=!0,n.apply(this,e)}.bind(this)))}}function L(){return new y}function A(e){return(new b(e,!0)).promise()}function O(e){return L().errback(e)}function M(e){return L().callback(e)}var o=r.forEach,u=i.isUndefinedOrNull,a=i.isArray,f=i.isFunction,l=i.isBoolean,c=s.bind,h=s.bindIgnore,d;if(typeof process!="undefined")d=process.nextTick;else if(typeof setImmediate=="function")d=setImmediate;else if(typeof MessageChannel!="undefined"){var v=new MessageChannel,m={},g=m;v.port1.onmessage=function(){m=m.next;var e=m.task;delete m.task,e()},d=function(e){g=g.next={task:e},v.port2.postMessage(0)}}else d=function(e){setTimeout(e,0)};var y=e({instance:{__fired:!1,__results:null,__error:null,__errorCbs:null,__cbs:null,constructor:function(){this.__errorCbs=[],this.__cbs=[],s.bindAll(this,["callback","errback","resolve","classic","__resolve","addCallback","addErrback"])},__resolve:function(){if(!this.__fired){this.__fired=!0;var e=this.__error?this.__errorCbs:this.__cbs,t=e.length,n,r=this.__error||this.__results;for(n=0;n<t;n++)this.__callNextTick(e[n],r)}},__callNextTick:function(e,t){d(function(){e.apply(this,t)})},addCallback:function(e){return e&&(E(e)&&e.callback&&(e=e.callback),this.__fired&&this.__results?this.__callNextTick(e,this.__results):this.__cbs.push(e)),this},addErrback:function(e){return e&&(E(e)&&e.errback&&(e=e.errback),this.__fired&&this.__error?this.__callNextTick(e,this.__error):this.__errorCbs.push(e)),this},callback:function(e){return this.__fired||(this.__results=arguments,this.__resolve()),this.promise()},errback:function(e){return this.__fired||(this.__error=arguments,this.__resolve()),this.promise()},resolve:function(e,n){return e?this.errback(e):this.callback.apply(this,t(arguments,1)),this},classic:function(e){return"function"==typeof e&&(this.addErrback(function(t){e(t)}),this.addCallback(function(){e.apply(this,[null].concat(t(arguments)))})),this},then:function(e,t){var n=new y,r=n;return f(t)&&(r=p(t,n)),this.addErrback(r),f(e)?this.addCallback(p(e,n)):this.addCallback(n),n.promise()},both:function(e){return this.then(e,e)},promise:function(){var e={then:c(this,"then"),both:c(this,"both"),promise:function(){return e}};return o(["addCallback","addErrback","classic"],function(t){e[t]=c(this,function(){return this[t].apply(this,arguments),e})},this),e}}}),b=y.extend({instance:{__results:null,__errors:null,__promiseLength:0,__defLength:0,__firedLength:0,normalizeResults:!1,constructor:function(e,t){this.__errors=[],this.__results=[],this.normalizeResults=l(t)?t:!1,this._super(arguments),e&&e.length?(this.__defLength=e.length,o(e,this.__addPromise,this)):this.__resolve()},__addPromise:function(e,n){e.then(c(this,function(){var e=t(arguments);e.unshift(n),this.callback.apply(this,e)}),c(this,function(){var e=t(arguments);e.unshift(n),this.errback.apply(this,e)}))},__resolve:function(){if(!this.__fired){this.__fired=!0;var e=this.__errors.length?this.__errorCbs:this.__cbs,t=e.length,n,r=this.__errors.length?this.__errors:this.__results;for(n=0;n<t;n++)this.__callNextTick(e[n],r)}},__callNextTick:function(e,t){d(function(){e.apply(null,[t])})},addCallback:function(e){return e&&(E(e)&&e.callback&&(e=c(e,"callback")),this.__fired&&!this.__errors.length?this.__callNextTick(e,this.__results):this.__cbs.push(e)),this},addErrback:function(e){return e&&(E(e)&&e.errback&&(e=c(e,"errback")),this.__fired&&this.__errors.length?this.__callNextTick(e,this.__errors):this.__errorCbs.push(e)),this},callback:function(e){if(this.__fired)throw new Error("Already fired!");var n=t(arguments);return this.normalizeResults&&(n=n.slice(1),n=n.length==1?n.pop():n),this.__results[e]=n,this.__firedLength++,this.__firedLength==this.__defLength&&this.__resolve(),this.promise()},errback:function(e){if(this.__fired)throw new Error("Already fired!");var n=t(arguments);return this.normalizeResults&&(n=n.slice(1),n=n.length==1?n.pop():n),this.__errors[e]=n,this.__firedLength++,this.__firedLength==this.__defLength&&this.__resolve(),this.promise()}}});return n.define({isPromiseLike:E}).expose({when:x,wrap:T,wait:k,serial:N,chain:C,Promise:y,PromiseList:b,promise:L,defer:L,deferredList:A,reject:O,resolve:M})}var e=Array.prototype.slice;"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(module.exports=n(require("declare.js"),require("extender"),require("array-extended"),require("is-extended"),require("function-extended"))):"function"==typeof define?define(["require"],function(e){return n(e("declare.js"),e("extender"),e("array-extended"),e("is-extended"),e("function-extended"))}):this.arrayExtended=n(this.declare,this.extender,this.arrayExtended,this.isExtended,this.functionExtended)}).call(this);