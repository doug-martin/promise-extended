/*! promise-extended - v0.0.6 - 2013-05-08
* Copyright (c) 2013 Doug Martin; Licensed MIT */
(function(){"use strict";function e(e,r){return r=r||0,t.call(e,r)}function r(r,t,n,i,s){function a(e,r){return function(){try{u(e.apply(null,arguments)).addCallback(r).addErrback(r)}catch(t){r.errback(t)}}}function c(e,r,t){var n=(new q).callback();return v(e,function(e){n=n.then(t?e:L(null,e)),t||(n=n.then(function(e){return r.push(e),r}))}),n}function o(e){return!y(e)&&w(e.then)}function l(e){var r=new q;return e.then(E(r,"callback"),E(r,"errback")),r.promise()}function u(r){var t;return r=e(arguments),r.length?1===r.length?(r=r.pop(),o(r)?r.addCallback&&r.addErrback?(t=new q,r.addCallback(t.callback),r.addErrback(t.errback)):t=l(r):t=x(r)&&n.every(r,o)?new A(r,!0).promise():(new q).callback(r)):t=new A(n.map(r,function(e){return u(e)}),!0).promise():t=(new q).callback(r).promise(),t}function h(r,t){return function(){var n=new q,i=e(arguments);return i.push(n.resolve),r.apply(t||this,i),n.promise()}}function _(e){if(x(e))return c(e,[],!1);throw Error("When calling promise.serial the first argument must be an array")}function d(e){if(x(e))return c(e,[],!0);throw Error("When calling promise.serial the first argument must be an array")}function f(r,t){r=e(arguments);var n=!1;t=r.pop();var i=u(r);return function(){return n?u(t.apply(this,arguments)):(r=arguments,i.then(E(this,function(){return n=!0,t.apply(this,r)})))}}function p(){return new q}function b(e){return new A(e,!0).promise()}function k(e){return p().errback(e)}function m(e){return p().callback(e)}var g,v=n.forEach,y=i.isUndefinedOrNull,x=i.isArray,w=i.isFunction,C=i.isBoolean,E=s.bind,L=s.bindIgnore;if("function"==typeof setImmediate)g="undefined"!=typeof window?setImmediate.bind(window):setImmediate;else if("undefined"!=typeof process)g=process.nextTick;else if("undefined"!=typeof MessageChannel){var T=new MessageChannel,N={},P=N;T.port1.onmessage=function(){N=N.next;var e=N.task;delete N.task,e()},g=function(e){P=P.next={task:e},T.port2.postMessage(0)}}else g=function(e){setTimeout(e,0)};var q=r({instance:{__fired:!1,__results:null,__error:null,__errorCbs:null,__cbs:null,constructor:function(){this.__errorCbs=[],this.__cbs=[],s.bindAll(this,["callback","errback","resolve","classic","__resolve","addCallback","addErrback"])},__resolve:function(){if(!this.__fired){this.__fired=!0;var e,r=this.__error?this.__errorCbs:this.__cbs,t=r.length,n=this.__error||this.__results;for(e=0;t>e;e++)this.__callNextTick(r[e],n)}},__callNextTick:function(e,r){g(function(){e.apply(this,r)})},addCallback:function(e){return e&&(o(e)&&e.callback&&(e=e.callback),this.__fired&&this.__results?this.__callNextTick(e,this.__results):this.__cbs.push(e)),this},addErrback:function(e){return e&&(o(e)&&e.errback&&(e=e.errback),this.__fired&&this.__error?this.__callNextTick(e,this.__error):this.__errorCbs.push(e)),this},callback:function(){return this.__fired||(this.__results=arguments,this.__resolve()),this.promise()},errback:function(){return this.__fired||(this.__error=arguments,this.__resolve()),this.promise()},resolve:function(r){return r?this.errback(r):this.callback.apply(this,e(arguments,1)),this},classic:function(r){return"function"==typeof r&&(this.addErrback(function(e){r(e)}),this.addCallback(function(){r.apply(this,[null].concat(e(arguments)))})),this},then:function(e,r){var t=new q,n=t;return w(r)&&(n=a(r,t)),this.addErrback(n),w(e)?this.addCallback(a(e,t)):this.addCallback(t),t.promise()},both:function(e){return this.then(e,e)},promise:function(){var e={then:E(this,"then"),both:E(this,"both"),promise:function(){return e}};return v(["addCallback","addErrback","classic"],function(r){e[r]=E(this,function(){return this[r].apply(this,arguments),e})},this),e}}}),A=q.extend({instance:{__results:null,__errors:null,__promiseLength:0,__defLength:0,__firedLength:0,normalizeResults:!1,constructor:function(e,r){this.__errors=[],this.__results=[],this.normalizeResults=C(r)?r:!1,this._super(arguments),e&&e.length?(this.__defLength=e.length,v(e,this.__addPromise,this)):this.__resolve()},__addPromise:function(r,t){r.then(E(this,function(){var r=e(arguments);r.unshift(t),this.callback.apply(this,r)}),E(this,function(){var r=e(arguments);r.unshift(t),this.errback.apply(this,r)}))},__resolve:function(){if(!this.__fired){this.__fired=!0;var e,r=this.__errors.length?this.__errorCbs:this.__cbs,t=r.length,n=this.__errors.length?this.__errors:this.__results;for(e=0;t>e;e++)this.__callNextTick(r[e],n)}},__callNextTick:function(e,r){g(function(){e.apply(null,[r])})},addCallback:function(e){return e&&(o(e)&&e.callback&&(e=E(e,"callback")),this.__fired&&!this.__errors.length?this.__callNextTick(e,this.__results):this.__cbs.push(e)),this},addErrback:function(e){return e&&(o(e)&&e.errback&&(e=E(e,"errback")),this.__fired&&this.__errors.length?this.__callNextTick(e,this.__errors):this.__errorCbs.push(e)),this},callback:function(r){if(this.__fired)throw Error("Already fired!");var t=e(arguments);return this.normalizeResults&&(t=t.slice(1),t=1===t.length?t.pop():t),this.__results[r]=t,this.__firedLength++,this.__firedLength===this.__defLength&&this.__resolve(),this.promise()},errback:function(r){if(this.__fired)throw Error("Already fired!");var t=e(arguments);return this.normalizeResults&&(t=t.slice(1),t=1===t.length?t.pop():t),this.__errors[r]=t,this.__firedLength++,this.__firedLength===this.__defLength&&this.__resolve(),this.promise()}}});return t.define({isPromiseLike:o}).expose({isPromiseLike:o,when:u,wrap:h,wait:f,serial:_,chain:d,Promise:q,PromiseList:A,promise:p,defer:p,deferredList:b,reject:k,resolve:m})}var t=Array.prototype.slice;"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(module.exports=r(require("declare.js"),require("extended"),require("array-extended"),require("is-extended"),require("function-extended"))):"function"==typeof define?define(["declare","extended","array-extended","is-extended","function-extended"],function(e,t,n,i,s){return r(e,t,n,i,s)}):this.promiseExtended=r(this.declare,this.extended,this.arrayExtended,this.isExtended,this.functionExtended)}).call(this);